{% extends 'core/base.html' %}

{% block title %}Buy Tickets - Coracle{% endblock %}

{% block head_content %}
<h1>Buy Tickets</h1>
<span class="subheading">Select your tickets for Coracle</span>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Ticket Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Ticket sales begin on June 29, 2025.</strong></p>
                <p>Coracle is a sanctioned Burning Man regional event. Burning Man Project is not a producer or organizer of Coracle, and Burning Man Project accepts no liability arising out of or in connection with Coracle.</p>
                <p>We strive to make Coracle a safe and beautiful experience for every participant. It is your responsibility to make sure you are not on any other regional's ban list. You will be denied entry and you will not get a refund.</p>
                <p>Coracle is open to participants of all ages. Children 12 and under are free. You will be asked to register your child at the gate, and we will also send this registration out before Coracle.</p>
            </div>
        </div>

        <form method="post" action="{% url 'create_checkout_session' %}" id="ticket-form">
            {% csrf_token %}

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Available Tickets</h5>
                </div>
                <div class="card-body">
                    {% for item in ticket_data %}
                    <div class="row align-items-center mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <div class="col-md-6">
                            <h6 class="mb-1">{{ item.ticket_type.label }}</h6>
                            <p class="text-muted mb-0 small">{{ item.ticket_type.description }}</p>
                        </div>
                        <div class="col-md-3 text-md-center">
                            <span class="fw-bold">${% widthratio item.ticket_type.price 100 1 %}.00</span>
                        </div>
                        <div class="col-md-3">
                            <input type="number" name="quantity_{{ item.ticket_type.id }}" id="qty_{{ item.ticket_type.id }}"
                                   class="form-control text-center qty-input" value="0" min="0" max="{{ item.remaining }}"
                                   data-price="{{ item.ticket_type.price }}" {% if item.remaining == 0 %}disabled{% endif %}>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Total:</h5>
                        <h4 class="mb-0" id="total-amount">$0.00</h4>
                    </div>
                </div>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg" id="checkout-btn" disabled>
                    Proceed to Checkout
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const qtyInputs = document.querySelectorAll('.qty-input');
    const totalEl = document.getElementById('total-amount');
    const checkoutBtn = document.getElementById('checkout-btn');

    function updateTotal() {
        let total = 0;
        qtyInputs.forEach(input => {
            const qty = parseInt(input.value) || 0;
            const price = parseInt(input.dataset.price) || 0;
            total += qty * price;
        });
        totalEl.textContent = '$' + (total / 100).toFixed(2);
        checkoutBtn.disabled = total === 0;
    }

    qtyInputs.forEach(input => {
        input.addEventListener('input', updateTotal);
    });

    updateTotal();
});
</script>
{% endblock %}
